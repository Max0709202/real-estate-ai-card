# Stripe決済フォームのZIPコード（郵便番号）について

## ZIPコードとは？

Stripe決済フォームに表示されるZIPコード（郵便番号）フィールドは、**Address Verification System (AVS)** というセキュリティ機能の一部です。

## なぜ5桁なのか？

### 1. カード発行国の自動検出

Stripe Elementsは、入力されたカード番号から**カードの発行国を自動的に検出**します：

- **アメリカ発行のカード**: 5桁のZIPコードを要求（例: 12345）
- **日本発行のカード**: 7桁の郵便番号を要求（例: 123-4567）
- **イギリス発行のカード**: 英数字の郵便番号を要求（例: SW1A 1AA）
- **カナダ発行のカード**: 6桁の郵便番号を要求（例: K1A 0B1）

### 2. デフォルト動作

カード番号が入力される前、またはカードの発行国が特定できない場合、Stripeは**デフォルトでアメリカ形式（5桁）**を表示することがあります。

## 日本の郵便番号について

日本の郵便番号は**7桁**です（例: 123-4567）。

### 動作確認

1. **日本のカード番号を入力**すると、Stripe Elementsは自動的に：
   - 7桁の郵便番号フィールドに変更
   - ハイフン（-）の入力も可能

2. **アメリカのカード番号を入力**すると：
   - 5桁のZIPコードフィールドに変更

## AVS（Address Verification System）の目的

ZIPコード/郵便番号の検証は、以下の目的で使用されます：

1. **不正利用の防止**: カード所有者の請求先住所と一致するか確認
2. **セキュリティ強化**: カード情報だけでは不十分な場合の追加認証
3. **承認率の向上**: 正しい住所情報により、決済の承認率が向上

## 現在の実装

現在のコード（`frontend/payment.php`）では、Stripe Elementsを標準設定で使用しています：

```javascript
const cardElement = elements.create('card', {
    style: {
        base: {
            fontSize: '16px',
            color: '#333',
            '::placeholder': {
                color: '#aab7c4',
            },
        },
        invalid: {
            color: '#dc3545',
        },
    },
});
```

この設定により、Stripeは自動的に：
- カード番号から発行国を検出
- 適切な郵便番号形式を要求

## 日本での使用時の注意点

### 問題が発生する場合

もし日本のカードを使用しているのに5桁のZIPコードが表示される場合：

1. **カード番号が正しく認識されていない**
   - カード番号を完全に入力する
   - カード番号の入力が完了すると、自動的に7桁フィールドに変更される

2. **テストカードを使用している場合**
   - Stripeのテストカード番号は通常アメリカ形式
   - 日本のテストカードを使用する場合は、適切なテストカード番号を使用

### 推奨される対応

現在の実装で問題ない場合：
- ✅ Stripe Elementsが自動的に適切な形式に調整するため、追加の設定は不要

より明示的に制御したい場合：
- カード番号の入力後に、郵便番号フィールドの形式を確認
- 日本のカードの場合は、7桁形式であることをユーザーに案内

## まとめ

| 項目 | 説明 |
|------|------|
| **ZIPコードの意味** | AVS（Address Verification System）によるセキュリティ検証 |
| **5桁の理由** | アメリカ発行カードのデフォルト形式、またはカード番号未入力時の表示 |
| **日本の場合** | カード番号入力後、自動的に7桁形式に変更される |
| **現在の実装** | Stripe Elementsの自動検出機能を使用（追加設定不要） |

## 参考リンク

- [Stripe Elements Documentation](https://stripe.com/docs/stripe-js/elements)
- [Stripe AVS Documentation](https://stripe.com/docs/security/avs)
- [Stripe Postal Code Requirements](https://stripe.com/docs/security/avs#postal-code-requirements)


