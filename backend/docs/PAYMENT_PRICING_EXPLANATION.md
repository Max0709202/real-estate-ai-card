# Payment Pricing Explanation

## 単一決済の合計金額

### 新規ユーザー（New User）

**初期費用（1回のみ）:**
- 税抜価格: ¥30,000
- 消費税（10%）: ¥3,000
- **合計: ¥33,000**

**月額費用（毎月）:**
- 税抜価格: ¥500
- 消費税（10%）: ¥50
- **合計: ¥550/月**

**注意:** 月額費用はサブスクリプションとして別途課金されます（初回決済時には含まれません）

### 既存ユーザー（Existing User）

**初期費用（1回のみ）:**
- 税抜価格: ¥20,000
- 消費税（10%）: ¥2,000
- **合計: ¥22,000**

**月額費用:** なし

---

## 支払い方法による金額の違い

### クレジットカード決済

**新規ユーザー:**
- 初回決済: ¥33,000（初期費用 + 税）
- その後: 毎月 ¥550（月額費用 + 税）が自動課金

**既存ユーザー:**
- 初回決済: ¥22,000（初期費用 + 税）
- 月額費用: なし

### 銀行振込

**新規ユーザー:**
- 初回決済: ¥33,000（初期費用 + 税）
- **月額費用は自動課金されません**（銀行振込ではサブスクリプションが作成されないため）

**既存ユーザー:**
- 初回決済: ¥22,000（初期費用 + 税）
- 月額費用: なし

**重要な違い:**
- クレジットカード: サブスクリプションが作成され、月額費用が自動課金される
- 銀行振込: サブスクリプションは作成されず、月額費用は別途手動で処理が必要

---

## Stripeサイトに表示される金額が異なる理由

### 1. 通貨単位の違い

**システム内の計算:**
```php
$totalAmount = 33000; // 円単位
```

**Stripeへの送信:**
```php
'amount' => (int)($totalAmount * 100) // 3,300,000
```

**問題:** 日本の円（JPY）は最小単位が1円であり、セント（cent）は存在しません。しかし、コードでは `* 100` をしているため、Stripeには **3,300,000** として送信されています。

**Stripeでの表示:**
- Stripe Dashboardでは、JPYの場合、自動的に100で割って表示します
- つまり、3,300,000 → ¥33,000 として表示されます
- しかし、これは意図した動作ではない可能性があります

### 2. 正しい実装

JPY（日本円）の場合、Stripeには以下のように送信すべきです：

```php
// 現在のコード（間違い）
'amount' => (int)($totalAmount * 100) // ¥33,000 → 3,300,000

// 正しいコード（JPYの場合）
'amount' => (int)$totalAmount // ¥33,000 → 33000
```

**Stripeのドキュメントより:**
- JPYは「zero-decimal currency」（小数点以下のない通貨）
- 1円 = 1単位（100倍する必要がない）
- USDなどの場合は $1.00 = 100 cents なので * 100 が必要

### 3. 実際の動作

現在のコードでは：
- システム: ¥33,000
- Stripe送信: 3,300,000（単位）
- Stripe表示: ¥33,000（自動的に100で割って表示）

**結果:** 表示上は正しく見えますが、内部的には100倍された値が送信されています。

---

## 金額計算の詳細

### 新規ユーザー（クレジットカード）

```
初期費用: ¥30,000（税抜）
消費税:   ¥30,000 × 10% = ¥3,000
─────────────────────────────
合計:     ¥33,000（初回決済）

月額費用: ¥500（税抜）
消費税:   ¥500 × 10% = ¥50
─────────────────────────────
合計:     ¥550/月（2回目以降、毎月自動課金）
```

### 新規ユーザー（銀行振込）

```
初期費用: ¥30,000（税抜）
消費税:   ¥30,000 × 10% = ¥3,000
─────────────────────────────
合計:     ¥33,000（初回決済のみ）

月額費用: 自動課金されません
         （手動で処理が必要）
```

### 既存ユーザー（クレジットカード/銀行振込）

```
初期費用: ¥20,000（税抜）
消費税:   ¥20,000 × 10% = ¥2,000
─────────────────────────────
合計:     ¥22,000（初回決済のみ）

月額費用: なし
```

---

## コード内の価格設定

```php
// backend/config/config.php
define('PRICING_NEW_USER_INITIAL', 30000);      // 税抜 ¥30,000
define('PRICING_NEW_USER_MONTHLY', 500);        // 税抜 ¥500
define('PRICING_EXISTING_USER_INITIAL', 20000); // 税抜 ¥20,000
define('TAX_RATE', 0.1);                        // 10%
```

---

## 修正済み

### 問題: JPYの金額計算

**修正済み箇所:**
- `backend/api/payment/create-intent.php` の line 158, 199, 287

**修正内容:**
```php
// 修正前
'amount' => (int)($totalAmount * 100)

// 修正後（JPYの場合）
'amount' => (int)$totalAmount
```

**修正理由:**
- JPY（日本円）は「zero-decimal currency」で、最小単位が1円
- Stripe APIでは、JPYの場合は金額をそのまま送信する必要がある
- 100倍すると、Stripe Dashboardでは自動的に100で割って表示されるが、内部的に誤った値が保存される可能性がある

---

## まとめ

| ユーザータイプ | 支払い方法 | 初回決済 | 月額費用 |
|------------|---------|---------|---------|
| 新規 | クレジットカード | ¥33,000 | ¥550/月（自動） |
| 新規 | 銀行振込 | ¥33,000 | なし（手動処理） |
| 既存 | クレジットカード | ¥22,000 | なし |
| 既存 | 銀行振込 | ¥22,000 | なし |

**Stripe表示の違い:**
- システム: 円単位（¥33,000）
- Stripe送信: 100倍された値（3,300,000単位）
- Stripe表示: 自動的に100で割って表示（¥33,000）

この修正を実装しますか？

